<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VV-3 Vocab</title>
    <style>
        :root {
            /* iOS Fresh Green Theme - VV-3 Fine Line Style */
            --primary: #34C759;
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 8px 30px rgba(0,0,0,0.06);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #000000;
                --bg-card: #1C1C1E;
                --text-main: #FFFFFF;
                --text-sub: #98989D;
                --border: #38383A;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- 顶部导航 (解决状态栏冲突) --- */
        .nav-bar {
            padding-top: calc(10px + var(--safe-top));
            padding-bottom: 12px;
            text-align: center;
            background: rgba(242, 242, 247, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 100;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        
        .progress-indicator {
            display: inline-block;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            letter-spacing: 0.5px;
            padding: 4px 16px;
            border: 1px solid var(--primary);
            border-radius: 20px;
        }

        /* --- 主容器 --- */
        .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(100px + var(--safe-bottom));
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .view.active { display: block; opacity: 1; }

        /* --- 1. 卡片视图 --- */
        #card-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .flash-card {
            background: var(--bg-card);
            border-radius: 28px;
            box-shadow: var(--shadow);
            padding: 40px 24px;
            text-align: center;
            position: relative;
            min-height: 440px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid var(--border);
        }

        .count-badge {
            position: absolute;
            top: 20px;
            right: 24px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-sub);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .word-main { 
            font-size: 40px; 
            font-weight: 800; 
            margin-bottom: 8px; 
            letter-spacing: -0.8px;
        }
        .word-ipa { 
            font-family: "Menlo", monospace; 
            color: var(--text-sub); 
            font-size: 16px; 
            margin-bottom: 30px; 
        }
        .word-meaning { 
            font-size: 18px; 
            line-height: 1.6; 
            margin-bottom: 30px; 
            color: var(--text-main); 
            font-weight: 400;
        }
        
        .related-area {
            font-size: 14px;
            color: var(--text-sub);
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .link-word {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            padding: 0 2px;
        }
        .plain-word { color: var(--text-sub); padding: 0 2px; }

        /* 线性发音按钮 (VV-3 Optimized) */
        .audio-btn-line {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary); /* 变细 */
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .audio-btn-line svg { width: 22px; height: 22px; fill: currentColor; }
        .audio-btn-line:active { background: rgba(52, 199, 89, 0.08); transform: scale(0.92); }

        /* --- 底部操作栏 --- */
        .action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 16px 24px calc(16px + var(--safe-bottom));
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(15px);
            display: flex;
            gap: 12px;
            z-index: 50;
            border-top: 0.5px solid var(--border);
        }

        .btn-line {
            flex: 1;
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary); /* 线性 */
            padding: 12px;
            border-radius: 12px;
            font-size: 15px; /* 小一号 */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-line:active { background: rgba(52, 199, 89, 0.08); transform: scale(0.96); }
        .btn-line:disabled { border-color: var(--border); color: var(--text-sub); opacity: 0.5; }

        /* --- 2. 列表视图 --- */
        .search-container {
            position: sticky;
            top: 0;
            background: var(--bg-body);
            padding-bottom: 12px;
            z-index: 10;
        }
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            font-size: 15px;
            outline: none;
        }
        .list-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }
        .list-word-text { font-weight: 700; font-size: 17px; margin-bottom: 2px; }
        .list-word-mean { font-size: 13px; color: var(--text-sub); }
        .list-stat { font-size: 10px; color: var(--text-sub); font-weight: 600; }

        /* --- Tab Switcher --- */
        .mode-floater {
            position: fixed;
            top: calc(10px + var(--safe-top));
            right: 16px;
            z-index: 101;
        }
        .btn-mode {
            font-size: 11px;
            color: var(--text-sub);
            font-weight: 700;
            padding: 5px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            text-transform: uppercase;
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .ios-modal {
            background: var(--bg-card);
            width: 80%;
            max-width: 320px;
            border-radius: 24px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transform: scale(0.9);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.2);
        }
        .modal-overlay.show .ios-modal { transform: scale(1); }
        .modal-btn {
            margin-top: 25px;
            width: 100%;
            padding: 10px;
            border: 1px solid var(--primary);
            color: var(--primary);
            background: transparent;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }

    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="progress-indicator" id="daily-progress">0 / 200</div>
    </div>

    <div class="mode-floater">
        <button class="btn-mode" id="mode-btn" onclick="toggleMode()">LIST</button>
    </div>

    <div class="view-container">
        <div id="card-view" class="view active"></div>

        <div id="list-view" class="view">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search dictionary..." oninput="filterList(this.value)">
            </div>
            <div id="list-content"></div>
        </div>
    </div>

    <div class="action-bar" id="card-actions">
        <button class="btn-line" id="prev-btn" onclick="prevCard()">PREVIOUS</button>
        <button class="btn-line" id="next-btn" onclick="nextCard()">NEXT</button>
    </div>

    <div class="modal-overlay" id="modal" onclick="closeModal()">
        <div class="ios-modal" onclick="event.stopPropagation()">
            <div class="word-main" id="modal-word" style="font-size: 26px;"></div>
            <div class="word-ipa" id="modal-ipa"></div>
            <div class="word-meaning" id="modal-mean" style="font-size: 15px;"></div>
            <button class="modal-btn" onclick="closeModal()">CLOSE</button>
        </div>
    </div>

    <script src="data.js"></script>

    <script>
        let WORD_INDEX = new Set();
        let ALL_WORDS_SORTED = [];
        const STATE = { todayBatch: [], currentIndex: 0, progress: {}, lastDate: null };

        const cardView = document.getElementById('card-view');
        const listView = document.getElementById('list-view');
        const listContent = document.getElementById('list-content');
        const dailyProgress = document.getElementById('daily-progress');
        const cardActions = document.getElementById('card-actions');
        const modeBtn = document.getElementById('mode-btn');
        const prevBtn = document.getElementById('prev-btn');

        window.onload = function() {
            if (typeof DATABASE === 'undefined') return;
            DATABASE.forEach(item => WORD_INDEX.add(item.w.toLowerCase()));
            ALL_WORDS_SORTED = [...DATABASE].sort((a, b) => a.w.localeCompare(b.w));
            loadState();
            generateDailyBatch();
            renderCard();
            renderListLazy(); 
        };

        function loadState() {
            const saved = localStorage.getItem('vv3_state');
            if (saved) {
                const data = JSON.parse(saved);
                STATE.progress = data.progress || {};
                STATE.lastDate = data.lastDate;
                STATE.todayBatch = data.todayBatch || [];
                STATE.currentIndex = data.currentIndex || 0;
            }
        }

        function saveState() {
            localStorage.setItem('vv3_state', JSON.stringify(STATE));
        }

        function generateDailyBatch() {
            const today = new Date().toDateString();
            if (STATE.lastDate !== today || STATE.todayBatch.length === 0) {
                const newBatch = [], oldBatch = [];
                DATABASE.forEach((item, i) => {
                    if (STATE.progress[item.w]) oldBatch.push(i);
                    else newBatch.push(i);
                });
                const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
                let selectedNew = shuffle(newBatch).slice(0, 120);
                let selectedOld = shuffle(oldBatch).slice(0, 80);
                STATE.todayBatch = selectedNew.concat(selectedOld);
                STATE.lastDate = today;
                STATE.currentIndex = 0;
                saveState();
            }
            dailyProgress.innerText = `${STATE.currentIndex} / ${STATE.todayBatch.length}`;
        }

        function renderCard() {
            if (STATE.currentIndex >= STATE.todayBatch.length) {
                cardView.innerHTML = `<div class="flash-card" style="justify-content:center;"><h2>COMPLETED!</h2><p style="color:var(--text-sub)">Well done for today.</p></div>`;
                cardActions.style.display = 'none';
                return;
            }
            cardActions.style.display = 'flex';
            const item = DATABASE[STATE.todayBatch[STATE.currentIndex]];
            const count = STATE.progress[item.w] || 0;

            let relatedHtml = 'NONE';
            if (item.g) {
                relatedHtml = item.g.split(',').map(rawW => {
                    const w = rawW.trim();
                    return WORD_INDEX.has(w.toLowerCase()) ? `<span class="link-word" onclick="showPopup('${w}')">${w}</span>` : `<span class="plain-word">${w}</span>`;
                }).join(', ');
            }

            cardView.innerHTML = `
                <div class="flash-card">
                    <div class="count-badge">REVIEWED: ${count}</div>
                    <div style="margin-top: 40px;">
                        <div class="word-main">${item.word || item.w}</div>
                        <div class="word-ipa">${item.i || ''}</div>
                        <div class="word-meaning">${item.m}</div>
                    </div>
                    <div>
                        <button class="audio-btn-line" onclick="playAudio('${item.w}')">
                            <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                        </button>
                        <div class="related-area">RELATED: ${relatedHtml}</div>
                    </div>
                </div>
            `;
            prevBtn.disabled = (STATE.currentIndex === 0);
            dailyProgress.innerText = `${STATE.currentIndex} / ${STATE.todayBatch.length}`;
        }

        window.prevCard = () => { if (STATE.currentIndex > 0) { STATE.currentIndex--; saveState(); renderCard(); } };
        window.nextCard = () => {
            const item = DATABASE[STATE.todayBatch[STATE.currentIndex]];
            STATE.progress[item.w] = (STATE.progress[item.w] || 0) + 1;
            STATE.currentIndex++;
            saveState();
            renderCard();
        };

        window.playAudio = (t) => {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'en-US';
            window.speechSynthesis.speak(u);
        };

        function renderListLazy(items = ALL_WORDS_SORTED) {
            let html = '';
            items.slice(0, 150).forEach(item => {
                const count = STATE.progress[item.w] || 0;
                html += `
                    <div class="list-item" onclick="showPopup('${item.w}')">
                        <div>
                            <div class="list-word-text">${item.w}</div>
                            <div class="list-word-mean">${item.m}</div>
                        </div>
                        <div class="list-stat">${count}</div>
                    </div>
                `;
            });
            listContent.innerHTML = html;
        }

        window.filterList = (q) => {
            const query = q.toLowerCase().trim();
            const filtered = query ? ALL_WORDS_SORTED.filter(i => i.w.toLowerCase().includes(query)) : ALL_WORDS_SORTED;
            renderListLazy(filtered);
        };

        window.toggleMode = () => {
            const isCard = cardView.classList.contains('active');
            cardView.classList.toggle('active', !isCard);
            listView.classList.toggle('active', isCard);
            cardActions.style.display = isCard ? 'none' : 'flex';
            modeBtn.innerText = isCard ? 'BACK' : 'LIST';
        };

        window.showPopup = (w) => {
            const target = DATABASE.find(i => i.w.toLowerCase() === w.toLowerCase());
            if (!target) return;
            document.getElementById('modal-word').innerText = target.w;
            document.getElementById('modal-ipa').innerText = target.i || '';
            document.getElementById('modal-mean').innerText = target.m;
            playAudio(target.w);
            document.getElementById('modal').classList.add('show');
        };

        window.closeModal = () => document.getElementById('modal').classList.remove('show');
    </script>
</body>
</html>
