<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>VV-1 Vocab</title>
    <style>
        :root {
            /* iOS Fresh Green Theme */
            --primary: #34C759;
            --primary-bg: #E8F8ED;
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #000000;
            --text-sub: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #000000;
                --bg-card: #1C1C1E;
                --text-main: #FFFFFF;
                --text-sub: #98989D;
                --border: #38383A;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- é¡¶éƒ¨å¯¼èˆª --- */
        .nav-bar {
            padding: calc(10px + var(--safe-top)) 20px 10px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 17px;
            z-index: 10;
        }
        .nav-title { color: var(--primary); }
        .progress-pill {
            font-size: 12px;
            background: var(--primary-bg);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
        }

        /* --- ä¸»è§†å›¾å®¹å™¨ --- */
        .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            padding: 20px;
            display: none; /* é»˜è®¤éšè— */
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .view.active { display: block; opacity: 1; }

        /* --- å¡ç‰‡è§†å›¾ (Card Mode) --- */
        #card-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 80px; /* ç•™å‡ºåº•éƒ¨æŒ‰é’®ç©ºé—´ */
        }

        .flash-card {
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 40px 24px;
            text-align: center;
            position: relative;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .count-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: var(--text-sub);
            background: var(--bg-body);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .word-main { font-size: 36px; font-weight: 700; margin-bottom: 8px; }
        .word-ipa { font-family: "Menlo", monospace; color: var(--text-sub); font-size: 15px; margin-bottom: 24px; }
        .word-meaning { font-size: 18px; line-height: 1.6; margin-bottom: 24px; color: var(--text-main); }
        
        .related-area {
            font-size: 14px;
            color: var(--text-sub);
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .link-word {
            color: var(--primary);
            text-decoration: none;
            margin: 0 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .audio-btn-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-bg);
            color: var(--primary);
            border: none;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: transform 0.1s;
        }
        .audio-btn-large:active { transform: scale(0.9); }

        .action-bar {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            padding: 0 20px;
        }
        .next-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }

        /* --- åˆ—è¡¨è§†å›¾ (List Mode) --- */
        .search-bar {
            position: sticky;
            top: 0;
            background: var(--bg-body);
            padding-bottom: 10px;
            z-index: 5;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: #E3E3E8;
            font-size: 16px;
            color: var(--text-main);
        }
        .list-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-word { font-weight: 600; font-size: 17px; }
        .list-mean { color: var(--text-sub); font-size: 14px; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- åº•éƒ¨ Tab --- */
        .tab-bar {
            padding-bottom: var(--safe-bottom);
            background: var(--bg-card);
            border-top: 0.5px solid var(--border);
            display: flex;
            justify-content: space-around;
        }
        .tab-item {
            padding: 12px;
            flex: 1;
            text-align: center;
            color: var(--text-sub);
            font-size: 12px;
            cursor: pointer;
        }
        .tab-item.active { color: var(--primary); }
        .tab-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        /* --- iOS é£æ ¼å¼¹çª— (Modal) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        
        .ios-modal {
            background: var(--bg-card);
            width: 80%;
            max-width: 320px;
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-overlay.show .ios-modal { transform: scale(1); }
        .modal-word { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .modal-close {
            margin-top: 20px;
            background: #E3E3E8;
            color: var(--text-main);
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-title">VV-1 Vocab</div>
        <div class="progress-pill" id="daily-progress">0 / 200</div>
    </div>

    <div class="view-container">
        <div id="card-view" class="view active">
            </div>

        <div id="list-view" class="view">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="æœç´¢å•è¯..." oninput="filterList(this.value)">
            </div>
            <div id="list-content">
                </div>
        </div>
    </div>

    <div class="action-bar" id="card-actions">
        <button class="next-btn" onclick="nextCard()">Next / è®°ä½äº†</button>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('card')">
            <span class="tab-icon">ğŸ“‡</span>
            èƒŒè¯µ
        </div>
        <div class="tab-item" onclick="switchTab('list')">
            <span class="tab-icon">ğŸ“‘</span>
            åˆ—è¡¨
        </div>
    </div>

    <div class="modal-overlay" id="modal" onclick="closeModal()">
        <div class="ios-modal" onclick="event.stopPropagation()">
            <div class="modal-word" id="modal-word">Word</div>
            <div class="word-ipa" id="modal-ipa">/ipa/</div>
            <div class="word-meaning" id="modal-mean">Meaning</div>
            <button class="modal-close" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>

    <script src="data.js"></script>

    <script>
        // --- VV-1 æ ¸å¿ƒé€»è¾‘ ---

        // çŠ¶æ€ç®¡ç†
        const STATE = {
            todayBatch: [],      // ä»Šæ—¥éœ€èƒŒå•è¯ç´¢å¼•åˆ—è¡¨
            currentIndex: 0,     // å½“å‰åœ¨ Batch ä¸­çš„ä½ç½®
            progress: {},        // è®°å¿†åº“: { "word": count }
            lastDate: null       // ä¸Šæ¬¡æ‰“å¼€æ—¥æœŸ
        };

        // DOM å…ƒç´ 
        const cardView = document.getElementById('card-view');
        const listView = document.getElementById('list-view');
        const listContent = document.getElementById('list-content');
        const dailyProgress = document.getElementById('daily-progress');
        const cardActions = document.getElementById('card-actions');

        // åˆå§‹åŒ–
        window.onload = function() {
            if (typeof DATABASE === 'undefined' || DATABASE.length === 0) {
                alert("æœªæ£€æµ‹åˆ° data.js æˆ–æ•°æ®ä¸ºç©ºï¼");
                return;
            }
            loadState();
            generateDailyBatch();
            renderCard();
            renderListLazy(); // åˆå§‹æ¸²æŸ“åˆ—è¡¨
        };

        // è¯»å–æœ¬åœ°å­˜å‚¨
        function loadState() {
            const saved = localStorage.getItem('vv1_state');
            if (saved) {
                const data = JSON.parse(saved);
                STATE.progress = data.progress || {};
                STATE.lastDate = data.lastDate;
                STATE.todayBatch = data.todayBatch || [];
                STATE.currentIndex = data.currentIndex || 0;
            }
        }

        // ä¿å­˜æœ¬åœ°å­˜å‚¨
        function saveState() {
            localStorage.setItem('vv1_state', JSON.stringify(STATE));
        }

        // ç”Ÿæˆä»Šæ—¥ä»»åŠ¡ (200è¯: 60%æ–° + 40%æ—§)
        function generateDailyBatch() {
            const today = new Date().toDateString();
            
            // å¦‚æœä»Šå¤©æ˜¯æ–°çš„ä¸€å¤©ï¼Œæˆ–è€…æ²¡æœ‰ä»»åŠ¡ï¼Œåˆ™ç”Ÿæˆæ–°ä»»åŠ¡
            if (STATE.lastDate !== today || STATE.todayBatch.length === 0) {
                const newWordsNeeded = 120; // 60%
                const oldWordsNeeded = 80;  // 40%
                
                let newBatch = [];
                let oldBatch = [];

                // éå†æ•°æ®åº“åˆ†ç±»
                for (let i = 0; i < DATABASE.length; i++) {
                    const word = DATABASE[i].w;
                    if (STATE.progress[word]) {
                        oldBatch.push(i);
                    } else {
                        newBatch.push(i);
                    }
                }

                // éšæœºæ‰“ä¹±è¾…åŠ©å‡½æ•°
                const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

                // é€‰å–å•è¯
                let selectedNew = shuffle(newBatch).slice(0, newWordsNeeded);
                let selectedOld = shuffle(oldBatch).slice(0, oldWordsNeeded);

                // è¡¥é½é€»è¾‘ (å¦‚æœæ—§è¯ä¸å¤Ÿï¼Œç”¨æ–°è¯è¡¥ï¼Œåä¹‹äº¦ç„¶)
                if (selectedOld.length < oldWordsNeeded) {
                    const moreNew = shuffle(newBatch).slice(newWordsNeeded, newWordsNeeded + (oldWordsNeeded - selectedOld.length));
                    selectedNew = selectedNew.concat(moreNew);
                }

                STATE.todayBatch = selectedNew.concat(selectedOld);
                STATE.lastDate = today;
                STATE.currentIndex = 0; // é‡ç½®è¿›åº¦
                saveState();
            }
            updateProgressUI();
        }

        // æ¸²æŸ“å½“å‰å¡ç‰‡
        function renderCard() {
            if (STATE.todayBatch.length === 0) {
                cardView.innerHTML = `<div class="flash-card" style="justify-content:center;"><h3>ä»Šæ—¥ä»»åŠ¡ç”Ÿæˆå¤±è´¥</h3></div>`;
                return;
            }

            if (STATE.currentIndex >= STATE.todayBatch.length) {
                cardView.innerHTML = `
                    <div class="flash-card" style="justify-content:center;">
                        <div style="font-size:50px;">ğŸ‰</div>
                        <h2>ä»Šæ—¥æ‰“å¡å®Œæˆ!</h2>
                        <p style="color:var(--text-sub)">å·²å®Œæˆ 200 ä¸ªå•è¯çš„è®°å¿†ä¸å¤ä¹ </p>
                    </div>`;
                cardActions.style.display = 'none';
                return;
            }

            const dbIndex = STATE.todayBatch[STATE.currentIndex];
            const item = DATABASE[dbIndex];
            const count = STATE.progress[item.w] || 0;

            // å¤„ç†å…³è”è¯é“¾æ¥
            let relatedHtml = 'æ— å…³è”è¯';
            if (item.g) {
                relatedHtml = item.g.split(',').map(w => {
                    const cleanW = w.trim();
                    return `<span class="link-word" onclick="showPopup('${cleanW}')">${cleanW}</span>`;
                }).join(', ');
            }

            cardView.innerHTML = `
                <div class="flash-card">
                    <div class="count-badge">å·²èƒŒ ${count} æ¬¡</div>
                    
                    <div style="margin-top: 40px;">
                        <div class="word-main">${item.w}</div>
                        <div class="word-ipa">${item.i || ''}</div>
                        <div class="word-meaning">${item.m}</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <button class="audio-btn-large" onclick="playAudio('${item.w}')">
                            ğŸ”Š
                        </button>
                        <div class="related-area">
                            å…³è”è¯: ${relatedHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // è‡ªåŠ¨æ’­æ”¾å‘éŸ³ (å¯é€‰)
            // playAudio(item.w); 
        }

        // ä¸‹ä¸€å¼ å¡ç‰‡é€»è¾‘
        window.nextCard = function() {
            if (STATE.currentIndex >= STATE.todayBatch.length) return;

            const dbIndex = STATE.todayBatch[STATE.currentIndex];
            const item = DATABASE[dbIndex];

            // æ›´æ–°è®°å¿†æ¬¡æ•°
            if (!STATE.progress[item.w]) STATE.progress[item.w] = 0;
            STATE.progress[item.w]++;

            // ç§»åŠ¨æŒ‡é’ˆ
            STATE.currentIndex++;
            
            saveState();
            updateProgressUI();
            renderCard();
        };

        // UI æ›´æ–°: è¿›åº¦æ¡
        function updateProgressUI() {
            dailyProgress.innerText = `${STATE.currentIndex} / ${STATE.todayBatch.length}`;
        }

        // åŠŸèƒ½: æ’­æ”¾å‘éŸ³
        window.playAudio = function(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        };

        // --- åˆ—è¡¨è§†å›¾é€»è¾‘ ---
        
        // æ‡’æ¸²æŸ“åˆ—è¡¨ (ä¸ºäº†æ€§èƒ½ï¼Œåªæ¸²æŸ“å‰ 100 ä¸ªï¼Œæˆ–è€…æœç´¢ç»“æœ)
        function renderListLazy(items = DATABASE) {
            const limit = 100;
            const displayItems = items.slice(0, limit);
            
            let html = '';
            displayItems.forEach(item => {
                html += `
                    <div class="list-item" onclick="showPopup('${item.w}')">
                        <div class="list-word">${item.w}</div>
                        <div class="list-mean">${item.m}</div>
                    </div>
                `;
            });
            
            if (items.length > limit) {
                html += `<div style="text-align:center; padding:10px; color:var(--text-sub);">ä»…æ˜¾ç¤ºå‰ ${limit} æ¡ï¼Œè¯·æœç´¢æŸ¥çœ‹æ›´å¤š</div>`;
            }
            
            listContent.innerHTML = html;
        }

        window.filterList = function(query) {
            query = query.toLowerCase().trim();
            if (!query) {
                renderListLazy(DATABASE);
                return;
            }
            const filtered = DATABASE.filter(item => item.w.toLowerCase().includes(query));
            renderListLazy(filtered);
        };

        // --- å¼¹çª—é€»è¾‘ ---
        window.showPopup = function(wordText) {
            const overlay = document.getElementById('modal');
            const wEl = document.getElementById('modal-word');
            const iEl = document.getElementById('modal-ipa');
            const mEl = document.getElementById('modal-mean');

            // åœ¨åº“ä¸­æŸ¥æ‰¾å•è¯
            const target = DATABASE.find(i => i.w.toLowerCase() === wordText.toLowerCase());

            if (target) {
                wEl.innerText = target.w;
                iEl.innerText = target.i || '';
                mEl.innerText = target.m;
                playAudio(target.w);
            } else {
                wEl.innerText = wordText;
                iEl.innerText = "";
                mEl.innerText = "è¯åº“ä¸­æœªæ‰¾åˆ°æ­¤å•è¯é‡Šä¹‰";
            }

            overlay.classList.add('show');
        };

        window.closeModal = function() {
            document.getElementById('modal').classList.remove('show');
        };

        // --- Tab åˆ‡æ¢ ---
        window.switchTab = function(tab) {
            const tabs = document.querySelectorAll('.tab-item');
            const views = document.querySelectorAll('.view');
            
            tabs.forEach(t => t.classList.remove('active'));
            views.forEach(v => v.classList.remove('active'));

            if (tab === 'card') {
                tabs[0].classList.add('active');
                cardView.classList.add('active');
                cardActions.style.display = 'block';
            } else {
                tabs[1].classList.add('active');
                listView.classList.add('active');
                cardActions.style.display = 'none'; // åˆ—è¡¨æ¨¡å¼éšè—åº•éƒ¨å¤§æŒ‰é’®
            }
        };

    </script>
</body>
</html>
