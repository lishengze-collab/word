<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>OV2 Vocab</title>
    <style>
        :root {
            --primary: #34C759;
            --alert: #FF3B30;
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --border: #E5E5EA;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #000000;
                --bg-card: #1C1C1E;
                --text-main: #FFFFFF;
                --text-sub: #98989D;
                --border: #38383A;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: -apple-system, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .header-bar {
            padding-top: calc(35px + var(--safe-top));
            padding-bottom: 15px;
            padding-left: 24px;
            padding-right: 24px;
            background: var(--bg-body);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            flex-shrink: 0;
        }

        .progress-indicator {
            font-size: 13px; font-weight: 700; color: var(--primary);
            border: 1px solid var(--primary); padding: 5px 14px; border-radius: 20px;
        }

        .btn-mode-top {
            font-size: 11px; font-weight: 800; color: var(--text-sub);
            letter-spacing: 1px; padding: 6px 16px;
            border: 1px solid var(--border); border-radius: 20px;
            background: transparent; text-transform: uppercase; cursor: pointer;
        }

        /* --- View Container --- */
        .view-container { flex: 1; position: relative; overflow: hidden; }
        
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 20px;
            padding-bottom: calc(140px + var(--safe-bottom));
            display: none; opacity: 0; transition: opacity 0.2s ease;
        }
        .view.active { display: block; opacity: 1; }

        /* --- Card View --- */
        #card-view { display: flex; flex-direction: column; justify-content: center; }
        .flash-card {
            background: var(--bg-card); border-radius: 32px;
            padding: 40px 24px; text-align: center; position: relative;
            min-height: 460px; display: flex; flex-direction: column;
            justify-content: space-between; border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.03);
        }
        
        .stay-timer-bar {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 0%; height: 4px; background: var(--primary);
            transition: width 30s linear; border-radius: 0 0 2px 2px;
        }

        .count-badge { position: absolute; top: 24px; right: 24px; font-size: 10px; font-weight: 700; color: var(--text-sub); }
        .word-main { font-size: 44px; font-weight: 800; margin-bottom: 8px; letter-spacing: -1px; }
        .red-text { color: var(--alert) !important; }
        .word-ipa { font-family: "Menlo", monospace; color: var(--text-sub); font-size: 15px; margin-bottom: 30px; }
        .word-meaning { font-size: 19px; line-height: 1.6; margin-bottom: 30px; }
        .related-area { font-size: 13px; color: var(--text-sub); padding-top: 20px; border-top: 1px solid var(--border); }
        
        /* 相关词样式：只有词库有的才有下划线和颜色 */
        .link-word-active { color: var(--primary); cursor: pointer; font-weight: 600; text-decoration: underline; }
        .link-word-static { color: var(--text-sub); font-weight: 400; }

        .audio-btn-line {
            width: 48px; height: 48px; border-radius: 50%;
            background: transparent; color: var(--primary); border: 1.2px solid var(--primary);
            margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center;
        }
        .audio-btn-line svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- Action Bar --- */
        .action-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 16px 24px calc(30px + var(--safe-bottom));
            background: transparent; display: flex; gap: 15px; z-index: 101;
        }
        .btn-line {
            flex: 1; background: var(--bg-card); color: var(--primary); border: 1.5px solid var(--primary);
            padding: 15px; border-radius: 30px; font-size: 14px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.8px; transition: 0.2s;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06); cursor: pointer;
        }
        .btn-line:active { opacity: 0.5; transform: scale(0.96); }

        /* --- List View: 搜索栏优化 --- */
        .search-container { 
            position: sticky; top: -20px; /* 抵消 view 的 padding */
            margin: 0 -20px; padding: 20px 20px 15px 20px;
            background: var(--bg-body); /* 确保不透明背景遮挡后面单词 */
            z-index: 10; 
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .search-input {
            width: 100%; padding: 16px; border-radius: 20px;
            border: 1px solid var(--border); background: var(--bg-card); font-size: 16px;
        }
        .list-item {
            background: var(--bg-card); padding: 18px; border-radius: 18px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--border); margin-bottom: 10px;
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            z-index: 200; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: 0.2s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .ios-modal {
            background: var(--bg-card); width: 88%; max-width: 340px;
            border-radius: 32px; padding: 35px 24px; text-align: center;
        }
        .modal-btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; }
        .modal-btn {
            width: 100%; padding: 14px; border: 1.5px solid var(--primary);
            color: var(--primary); background: transparent; border-radius: 25px;
            font-weight: 700; font-size: 13px; text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div class="header-bar">
        <div class="progress-indicator" id="daily-progress">0 / 200</div>
        <button class="btn-mode-top" id="mode-btn" onclick="toggleMode()">LIST</button>
    </div>

    <div class="view-container">
        <div id="card-view" class="view active"></div>
        <div id="list-view" class="view" onscroll="handleListScroll(this)">
            <div class="search-container">
                <input type="text" id="search-in" class="search-input" placeholder="搜索 1800+ 词汇..." oninput="handleSearch(this.value)">
            </div>
            <div id="list-content" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div class="action-bar" id="card-actions">
        <button class="btn-line" id="prev-btn" onclick="prevCard()">PREVIOUS</button>
        <button class="btn-line" id="next-btn" onclick="nextCard()">NEXT</button>
    </div>

    <div class="modal-overlay" id="modal" onclick="closeModal()">
        <div class="ios-modal" onclick="event.stopPropagation()">
            <div class="word-main" id="modal-word"></div>
            <div class="word-ipa" id="modal-ipa"></div>
            <div class="word-meaning" id="modal-mean"></div>
            <div class="modal-btn-group">
                <button class="modal-btn" onclick="closeModal()">关闭</button>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        let WORD_INDEX_SET = new Set();
        let ALL_WORDS_SORTED = [];
        let FILTERED_ITEMS = [];
        const STATE = { todayBatch: [], currentIndex: 0, progress: {}, lastDate: null, forcedOld: [] };
        
        let stayTimer = null;
        let listPage = 1;
        const PAGE_SIZE = 50;

        window.onload = function() {
            if (typeof DATABASE === 'undefined') return;
            DATABASE.forEach(item => WORD_INDEX_SET.add(item.w.toLowerCase()));
            ALL_WORDS_SORTED = [...DATABASE].sort((a, b) => a.w.localeCompare(b.w));
            FILTERED_ITEMS = ALL_WORDS_SORTED;
            
            loadState();
            generateDailyBatch();
            renderCard();
            renderList(); 
        };

        function loadState() {
            const saved = localStorage.getItem('ov2_state');
            if (saved) Object.assign(STATE, JSON.parse(saved));
        }
        function saveState() { localStorage.setItem('ov2_state', JSON.stringify(STATE)); }

        function generateDailyBatch() {
            const today = new Date().toDateString();
            if (STATE.lastDate !== today || STATE.todayBatch.length === 0) {
                const newWords = [], oldWords = [];
                DATABASE.forEach((item, i) => {
                    if (STATE.progress[item.w] || STATE.forcedOld.includes(item.w)) oldWords.push(i);
                    else newWords.push(i);
                });
                const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
                STATE.todayBatch = shuffle(newWords).slice(0, 120).concat(shuffle(oldWords).slice(0, 80));
                STATE.lastDate = today; STATE.currentIndex = 0;
                saveState();
            }
            updateProgressText();
        }

        function updateProgressText() {
            document.getElementById('daily-progress').innerText = `${STATE.currentIndex} / ${STATE.todayBatch.length}`;
        }

        function startStayTimer(word) {
            const bar = document.getElementById('stay-timer-line');
            if(bar) { 
                bar.style.transition = 'none'; bar.style.width = '0%'; bar.style.background = 'var(--primary)';
                setTimeout(()=> { bar.style.transition = 'width 30s linear'; bar.style.width = '100%'; }, 50); 
            }
            if(stayTimer) clearTimeout(stayTimer);
            stayTimer = setTimeout(() => {
                if(!STATE.forcedOld.includes(word)) { STATE.forcedOld.push(word); saveState(); }
                if(bar) bar.style.background = 'var(--alert)';
            }, 30000);
        }

        // 核心优化：构建带有智能跳转的相关词 HTML
        function getRelatedHTML(gStr) {
            if (!gStr) return '无';
            return gStr.split(',').map(rawW => {
                const w = rawW.trim();
                const exists = WORD_INDEX_SET.has(w.toLowerCase());
                if (exists) {
                    return `<span class="link-word-active" onclick="showPopup('${w}')">${w}</span>`;
                } else {
                    return `<span class="link-word-static">${w}</span>`;
                }
            }).join(', ');
        }

        function renderCard() {
            const container = document.getElementById('card-view');
            const actionBar = document.getElementById('card-actions');
            
            if (STATE.currentIndex >= STATE.todayBatch.length) {
                container.innerHTML = `<div class="flash-card" style="justify-content:center;"><h2>今日任务已完成</h2><button class="modal-btn" style="margin-top:20px;width:120px;align-self:center;" onclick="STATE.currentIndex=0;renderCard();">重学</button></div>`;
                actionBar.style.display = 'none';
                return;
            }

            actionBar.style.display = 'flex';
            const item = DATABASE[STATE.todayBatch[STATE.currentIndex]];
            const count = STATE.progress[item.w] || 0;

            container.innerHTML = `
                <div class="flash-card">
                    <div id="stay-timer-line" class="stay-timer-bar"></div>
                    <div class="count-badge">复习次数: ${count}</div>
                    <div style="margin-top: 40px;">
                        <div class="word-main ${count >= 5 ? 'red-text' : ''}">${item.w}</div>
                        <div class="word-ipa">${item.i || ''}</div>
                        <div class="word-meaning">${item.m}</div>
                    </div>
                    <div>
                        <button class="audio-btn-line" onclick="playAudio('${item.w}')">
                            <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                        </button>
                        <div class="related-area">相关词: ${getRelatedHTML(item.g)}</div>
                    </div>
                </div>
            `;
            startStayTimer(item.w);
            document.getElementById('prev-btn').disabled = (STATE.currentIndex === 0);
            updateProgressText();
        }

        function renderList(append = false) {
            const listContent = document.getElementById('list-content');
            if (!append) { listContent.innerHTML = ''; listPage = 1; }
            const start = (listPage - 1) * PAGE_SIZE;
            const chunk = FILTERED_ITEMS.slice(start, start + PAGE_SIZE);

            const fragment = document.createDocumentFragment();
            chunk.forEach(item => {
                const count = STATE.progress[item.w] || 0;
                const div = document.createElement('div');
                div.className = 'list-item';
                div.setAttribute('data-word', item.w);
                div.innerHTML = `<div><div class="list-word-text ${count>=5?'red-text':''}">${item.w}</div><div class="list-word-mean" style="font-size:13px; color:var(--text-sub); margin-top:4px;">${item.m}</div></div><div class="list-stat" style="font-size:11px; font-weight:700; color:var(--text-sub);">次数: ${count}</div>`;
                fragment.appendChild(div);
            });
            listContent.appendChild(fragment);
        }

        document.getElementById('list-content').addEventListener('click', (e) => {
            const item = e.target.closest('.list-item');
            if (item) showPopup(item.getAttribute('data-word'));
        });

        window.handleListScroll = (el) => {
            if (el.scrollTop + el.clientHeight >= el.scrollHeight - 120) {
                if (listPage * PAGE_SIZE < FILTERED_ITEMS.length) { listPage++; renderList(true); }
            }
        };

        window.handleSearch = (q) => {
            const query = q.toLowerCase().trim();
            FILTERED_ITEMS = query ? ALL_WORDS_SORTED.filter(i => i.w.toLowerCase().includes(query)) : ALL_WORDS_SORTED;
            renderList();
        };

        window.toggleMode = () => {
            const isCardActive = document.getElementById('card-view').classList.contains('active');
            const cardView = document.getElementById('card-view');
            const listView = document.getElementById('list-view');
            const actionBar = document.getElementById('card-actions');
            const modeBtn = document.getElementById('mode-btn');
            
            if (isCardActive) {
                cardView.classList.remove('active');
                listView.classList.add('active');
                actionBar.style.display = 'none';
                modeBtn.innerText = 'BACK';
                renderList();
            } else {
                listView.classList.remove('active');
                cardView.classList.add('active');
                actionBar.style.display = 'flex';
                modeBtn.innerText = 'LIST';
                renderCard();
            }
        };

        window.showPopup = (w) => {
            const target = DATABASE.find(i => i.w.toLowerCase() === w.toLowerCase());
            if (!target) return;
            const count = STATE.progress[target.w] || 0;
            document.getElementById('modal-word').innerText = target.w;
            document.getElementById('modal-word').className = count >= 5 ? 'word-main red-text' : 'word-main';
            document.getElementById('modal-ipa').innerText = target.i || '';
            document.getElementById('modal-mean').innerText = target.m;
            playAudio(target.w);
            document.getElementById('modal').classList.add('show');
        };

        window.prevCard = () => { if (STATE.currentIndex > 0) { STATE.currentIndex--; renderCard(); } };
        window.nextCard = () => {
            const item = DATABASE[STATE.todayBatch[STATE.currentIndex]];
            STATE.progress[item.w] = (STATE.progress[item.w] || 0) + 1;
            STATE.currentIndex++;
            saveState(); renderCard();
        };

        window.playAudio = (t) => {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t); u.lang = 'en-US';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        };

        window.closeModal = () => document.getElementById('modal').classList.remove('show');
    </script>
</body>
</html>
