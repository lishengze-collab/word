<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VV-2 Vocab</title>
    <style>
        :root {
            /* iOS Fresh Green Theme - Outline Style */
            --primary: #34C759;
            --primary-active: #248A3D;
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
            
            /* Safe Area Variables */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #000000;
                --bg-card: #1C1C1E;
                --text-main: #FFFFFF;
                --text-sub: #98989D;
                --border: #38383A;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- é¡¶éƒ¨å¯¼èˆª (é€‚é…åˆ˜æµ·å±) --- */
        .nav-bar {
            padding-top: calc(12px + var(--safe-top));
            padding-bottom: 12px;
            padding-left: 20px;
            padding-right: 20px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            z-index: 100;
        }
        .nav-title { 
            font-weight: 700; 
            font-size: 18px; 
            color: var(--text-main);
        }
        .progress-pill {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
        }

        /* --- ä¸»è§†å›¾å®¹å™¨ --- */
        .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(100px + var(--safe-bottom)); /* é˜²æ­¢åº•éƒ¨æŒ‰é’®é®æŒ¡ */
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .view.active { display: block; opacity: 1; }

        /* --- 1. å¡ç‰‡è§†å›¾ --- */
        #card-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .flash-card {
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 40px 24px;
            text-align: center;
            position: relative;
            min-height: 420px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid var(--border);
        }

        .count-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-sub);
            background: var(--bg-body);
            padding: 4px 10px;
            border-radius: 8px;
        }

        .word-main { 
            font-size: 38px; 
            font-weight: 800; 
            margin-bottom: 6px; 
            letter-spacing: -0.5px;
        }
        .word-ipa { 
            font-family: "Menlo", monospace; 
            color: var(--text-sub); 
            font-size: 16px; 
            margin-bottom: 24px; 
        }
        .word-meaning { 
            font-size: 19px; 
            line-height: 1.5; 
            margin-bottom: 30px; 
            color: var(--text-main); 
            font-weight: 500;
        }
        
        /* å…³è”è¯åŒºåŸŸ */
        .related-area {
            font-size: 15px;
            color: var(--text-sub);
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        /* æœ‰æ•ˆé“¾æ¥æ ·å¼ */
        .link-word {
            color: var(--primary);
            text-decoration: none;
            margin: 0 4px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 1px dashed rgba(52, 199, 89, 0.3);
        }
        /* æ— æ•ˆé“¾æ¥æ ·å¼ï¼ˆçº¯æ–‡æœ¬ï¼‰ */
        .plain-word {
            color: var(--text-sub);
            margin: 0 4px;
        }

        /* çº¿æ€§å‘éŸ³æŒ‰é’® */
        .audio-btn-outline {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.1s;
        }
        .audio-btn-outline:active {
            background: rgba(52, 199, 89, 0.1);
            transform: scale(0.95);
        }

        /* --- åº•éƒ¨æ“ä½œæ  (çº¿æ€§æŒ‰é’®) --- */
        .action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 16px 20px calc(16px + var(--safe-bottom));
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            display: flex;
            gap: 12px;
            z-index: 50;
            border-top: 0.5px solid var(--border);
        }

        .btn-outline {
            flex: 1;
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 14px;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .btn-outline:active {
            background: rgba(52, 199, 89, 0.1);
            transform: scale(0.98);
        }

        /* ç‰¹æ®Šï¼šç¦ç”¨çŠ¶æ€ */
        .btn-outline:disabled {
            border-color: var(--text-sub);
            color: var(--text-sub);
            opacity: 0.5;
        }

        /* --- 2. åˆ—è¡¨è§†å›¾ --- */
        .search-container {
            position: sticky;
            top: 0;
            background: var(--bg-body);
            padding-bottom: 10px;
            z-index: 10;
        }
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            font-size: 16px;
            color: var(--text-main);
            outline: none;
        }
        .list-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }
        .list-item:active { border-color: var(--primary); }
        
        .list-word-col { flex: 1; min-width: 0; }
        .list-word-text { font-weight: 700; font-size: 17px; margin-bottom: 4px; }
        .list-word-mean { font-size: 13px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .list-stat {
            font-size: 12px;
            color: var(--text-sub);
            background: var(--bg-body);
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 10px;
            white-space: nowrap;
        }

        /* --- åº•éƒ¨ Tab --- */
        /* ç”±äºåŠŸèƒ½é”®å¾ˆå¤§ï¼ŒTab å¯ä»¥ç®€åŒ–æˆ–ç¼©å°ï¼Œè¿™é‡Œä¸ºäº†ä¿æŒ VV-1 é€»è¾‘ï¼Œä¿ç•™ä½†åœ¨å¡ç‰‡é¡µéšè—ï¼Œä»…åœ¨åˆ—è¡¨é¡µæ˜¾ç¤ºæˆ–æµ®åŠ¨åˆ‡æ¢ */
        .tab-floater {
            position: fixed;
            top: calc(12px + var(--safe-top));
            right: 20px;
            z-index: 101;
            background: transparent;
        }
        .tab-switch-btn {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
            padding: 6px 12px;
            border: 1px solid var(--primary);
            border-radius: 20px;
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(5px);
        }

        /* --- å¼¹çª— (Modal) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        
        .ios-modal {
            background: var(--bg-card);
            width: 85%;
            max-width: 340px;
            border-radius: 24px;
            padding: 28px 24px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .modal-overlay.show .ios-modal { transform: scale(1); }
        .modal-btn {
            margin-top: 24px;
            width: 100%;
            padding: 12px;
            border: 2px solid var(--primary);
            color: var(--primary);
            background: transparent;
            border-radius: 14px;
            font-weight: 600;
            font-size: 16px;
        }

    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-title">VV-2</div>
        <div class="progress-pill" id="daily-progress">0 / 200</div>
    </div>

    <div class="tab-floater">
        <button class="tab-switch-btn" id="mode-btn" onclick="toggleMode()">åˆ—è¡¨æ¨¡å¼</button>
    </div>

    <div class="view-container">
        
        <div id="card-view" class="view active">
            </div>

        <div id="list-view" class="view">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search A-Z..." oninput="filterList(this.value)">
            </div>
            <div id="list-content">
                </div>
        </div>

    </div>

    <div class="action-bar" id="card-actions">
        <button class="btn-outline" id="prev-btn" onclick="prevCard()">â† ä¸Šä¸€ä¸ª</button>
        <button class="btn-outline" id="next-btn" onclick="nextCard()">Next â†’</button>
    </div>

    <div class="modal-overlay" id="modal" onclick="closeModal()">
        <div class="ios-modal" onclick="event.stopPropagation()">
            <div class="word-main" id="modal-word" style="font-size: 28px;">Word</div>
            <div class="word-ipa" id="modal-ipa"></div>
            <div class="word-meaning" id="modal-mean" style="font-size: 16px; margin-bottom: 10px;">Meaning</div>
            <button class="modal-btn" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script src="data.js"></script>

    <script>
        // --- VV-2 æ ¸å¿ƒé€»è¾‘ ---

        // å•è¯ç´¢å¼• Set (ç”¨äºå¿«é€Ÿæ£€æŸ¥å…³è”è¯æ˜¯å¦å­˜åœ¨)
        let WORD_INDEX = new Set();
        let ALL_WORDS_SORTED = [];

        // çŠ¶æ€ç®¡ç†
        const STATE = {
            todayBatch: [],      
            currentIndex: 0,     
            progress: {},        // { "word": count }
            lastDate: null
        };

        // DOM
        const cardView = document.getElementById('card-view');
        const listView = document.getElementById('list-view');
        const listContent = document.getElementById('list-content');
        const dailyProgress = document.getElementById('daily-progress');
        const cardActions = document.getElementById('card-actions');
        const modeBtn = document.getElementById('mode-btn');
        const prevBtn = document.getElementById('prev-btn');

        // åˆå§‹åŒ–
        window.onload = function() {
            if (typeof DATABASE === 'undefined' || DATABASE.length === 0) {
                alert("Data Error: DATABASE not found.");
                return;
            }

            // 1. å»ºç«‹ç´¢å¼• & æ’åºå…¨é‡åˆ—è¡¨ (A-Z)
            DATABASE.forEach(item => WORD_INDEX.add(item.w.toLowerCase()));
            ALL_WORDS_SORTED = [...DATABASE].sort((a, b) => a.w.localeCompare(b.w));

            // 2. åŠ è½½çŠ¶æ€ & ç”Ÿæˆä»»åŠ¡
            loadState();
            generateDailyBatch();

            // 3. åˆå§‹æ¸²æŸ“
            renderCard();
            renderListLazy(); 
        };

        function loadState() {
            const saved = localStorage.getItem('vv2_state'); // å‡çº§keyé¿å…å†²çª
            if (saved) {
                const data = JSON.parse(saved);
                STATE.progress = data.progress || {};
                STATE.lastDate = data.lastDate;
                STATE.todayBatch = data.todayBatch || [];
                STATE.currentIndex = data.currentIndex || 0;
            }
        }

        function saveState() {
            localStorage.setItem('vv2_state', JSON.stringify(STATE));
        }

        // ç”Ÿæˆä»»åŠ¡é€»è¾‘ (ä¿æŒ VV-1 é€»è¾‘: 60%æ–° + 40%æ—§)
        function generateDailyBatch() {
            const today = new Date().toDateString();
            if (STATE.lastDate !== today || STATE.todayBatch.length === 0) {
                const newWordsNeeded = 120;
                const oldWordsNeeded = 80;
                let newBatch = [], oldBatch = [];

                for (let i = 0; i < DATABASE.length; i++) {
                    const word = DATABASE[i].w;
                    if (STATE.progress[word]) oldBatch.push(i);
                    else newBatch.push(i);
                }

                const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
                let selectedNew = shuffle(newBatch).slice(0, newWordsNeeded);
                let selectedOld = shuffle(oldBatch).slice(0, oldWordsNeeded);

                if (selectedOld.length < oldWordsNeeded) {
                    const moreNew = shuffle(newBatch).slice(newWordsNeeded, newWordsNeeded + (oldWordsNeeded - selectedOld.length));
                    selectedNew = selectedNew.concat(moreNew);
                }

                STATE.todayBatch = selectedNew.concat(selectedOld);
                STATE.lastDate = today;
                STATE.currentIndex = 0;
                saveState();
            }
            updateUI();
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCard() {
            if (STATE.todayBatch.length === 0) return;

            // å®ŒæˆçŠ¶æ€
            if (STATE.currentIndex >= STATE.todayBatch.length) {
                cardView.innerHTML = `
                    <div class="flash-card" style="justify-content:center; border: 2px solid var(--primary);">
                        <div style="font-size:60px;">ğŸ‰</div>
                        <h2>ä»Šæ—¥ä»»åŠ¡è¾¾æˆ</h2>
                        <p style="color:var(--text-sub)">Take a break!</p>
                    </div>`;
                cardActions.style.display = 'none';
                return;
            } else {
                cardActions.style.display = 'flex';
            }

            const dbIndex = STATE.todayBatch[STATE.currentIndex];
            const item = DATABASE[dbIndex];
            const count = STATE.progress[item.w] || 0;

            // å…³è”è¯å¤„ç† (ä»…æ˜¾ç¤ºå­˜åœ¨çš„è¯ä¸ºé“¾æ¥)
            let relatedHtml = 'æ— ';
            if (item.g) {
                relatedHtml = item.g.split(',').map(rawW => {
                    const w = rawW.trim();
                    // æ£€æŸ¥è¯åº“æ˜¯å¦å­˜åœ¨è¯¥è¯
                    if (WORD_INDEX.has(w.toLowerCase())) {
                        return `<span class="link-word" onclick="showPopup('${w}')">${w}</span>`;
                    } else {
                        return `<span class="plain-word">${w}</span>`;
                    }
                }).join(''); // å»æ‰é€—å·ï¼Œç”¨é—´è·éš”å¼€ï¼Œæˆ–è€…ä¿ç•™é€—å·
                // è¿™é‡Œä¸ºäº†ç¾è§‚ï¼Œä¸Šé¢mapè¿”å›spanï¼Œjoinå¯ä»¥åŠ é€—å·
                relatedHtml = item.g.split(',').map(rawW => {
                     const w = rawW.trim();
                     if (WORD_INDEX.has(w.toLowerCase())) {
                        return `<span class="link-word" onclick="showPopup('${w}')">${w}</span>`;
                     } else {
                        return `<span class="plain-word">${w}</span>`;
                     }
                }).join(', ');
            }

            cardView.innerHTML = `
                <div class="flash-card">
                    <div class="count-badge">èƒŒè¿‡ ${count} æ¬¡</div>
                    
                    <div style="margin-top: 50px;">
                        <div class="word-main">${item.w}</div>
                        <div class="word-ipa">${item.i || ''}</div>
                        <div class="word-meaning">${item.m}</div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <button class="audio-btn-outline" onclick="playAudio('${item.w}')">
                            ğŸ”Š
                        </button>
                        <div class="related-area">
                            å…³è”è¯: ${relatedHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            prevBtn.disabled = (STATE.currentIndex === 0);
            updateUI();
        }

        // ä¸Šä¸€ä¸ª
        window.prevCard = function() {
            if (STATE.currentIndex > 0) {
                STATE.currentIndex--;
                saveState();
                renderCard();
            }
        };

        // ä¸‹ä¸€ä¸ª (Next)
        window.nextCard = function() {
            if (STATE.currentIndex < STATE.todayBatch.length) {
                const dbIndex = STATE.todayBatch[STATE.currentIndex];
                const item = DATABASE[dbIndex];

                // è®°å½•æ¬¡æ•°
                if (!STATE.progress[item.w]) STATE.progress[item.w] = 0;
                STATE.progress[item.w]++;

                STATE.currentIndex++;
                saveState();
                renderCard();
                
                // å¦‚æœåœ¨åˆ—è¡¨æ¨¡å¼ï¼Œä¹Ÿåˆ·æ–°ä¸€ä¸‹è®¡æ•°æ˜¾ç¤º
                if(listView.classList.contains('active')) {
                   // å¯é€‰ï¼šå®æ—¶åˆ·æ–°åˆ—è¡¨
                }
            }
        };

        function updateUI() {
            dailyProgress.innerText = `${STATE.currentIndex} / ${STATE.todayBatch.length}`;
        }

        window.playAudio = function(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        };

        // --- åˆ—è¡¨é€»è¾‘ (A-Z) ---
        function renderListLazy(items = ALL_WORDS_SORTED) {
            // æ€§èƒ½ä¼˜åŒ–ï¼šåªæ¸²æŸ“å‰ 200 ä¸ªï¼Œæœç´¢æ—¶æ‰å…¨é‡ç­›é€‰
            const limit = 200;
            const displayItems = items.slice(0, limit);
            
            let html = '';
            displayItems.forEach(item => {
                const count = STATE.progress[item.w] || 0;
                html += `
                    <div class="list-item" onclick="showPopup('${item.w}')">
                        <div class="list-word-col">
                            <div class="list-word-text">${item.w}</div>
                            <div class="list-word-mean">${item.m}</div>
                        </div>
                        <div class="list-stat">ğŸ‘€ ${count}</div>
                    </div>
                `;
            });
            
            if (items.length > limit) {
                html += `<div style="text-align:center; padding:20px; color:var(--text-sub);">...è¾“å…¥æœç´¢æŸ¥çœ‹æ›´å¤š...</div>`;
            }
            listContent.innerHTML = html;
        }

        window.filterList = function(query) {
            query = query.toLowerCase().trim();
            if (!query) {
                renderListLazy(ALL_WORDS_SORTED);
                return;
            }
            const filtered = ALL_WORDS_SORTED.filter(item => item.w.toLowerCase().includes(query));
            renderListLazy(filtered);
        };

        // --- æ¨¡å¼åˆ‡æ¢ ---
        window.toggleMode = function() {
            if (cardView.classList.contains('active')) {
                // åˆ‡æ¢åˆ°åˆ—è¡¨
                cardView.classList.remove('active');
                cardActions.style.display = 'none';
                listView.classList.add('active');
                modeBtn.innerText = "èƒŒè¯µæ¨¡å¼";
                // åˆ·æ–°åˆ—è¡¨ï¼ˆä¸ºäº†æ›´æ–°è®¡æ•°ï¼‰
                filterList(document.querySelector('.search-input').value);
            } else {
                // åˆ‡æ¢åˆ°èƒŒè¯µ
                listView.classList.remove('active');
                cardView.classList.add('active');
                cardActions.style.display = (STATE.currentIndex >= STATE.todayBatch.length) ? 'none' : 'flex';
                modeBtn.innerText = "åˆ—è¡¨æ¨¡å¼";
            }
        };

        // --- å¼¹çª—é€»è¾‘ ---
        window.showPopup = function(wordText) {
            const overlay = document.getElementById('modal');
            const wEl = document.getElementById('modal-word');
            const iEl = document.getElementById('modal-ipa');
            const mEl = document.getElementById('modal-mean');

            // æŸ¥æ‰¾å•è¯
            const target = DATABASE.find(i => i.w.toLowerCase() === wordText.toLowerCase());

            if (target) {
                wEl.innerText = target.w;
                iEl.innerText = target.i || '';
                mEl.innerText = target.m;
                playAudio(target.w);
            } else {
                // ç†è®ºä¸Šå‰é¢è¿‡æ»¤äº†ï¼Œè¿™é‡Œæ˜¯å…œåº•
                return; 
            }
            overlay.classList.add('show');
        };

        window.closeModal = function() {
            document.getElementById('modal').classList.remove('show');
        };

    </script>
</body>
</html>
